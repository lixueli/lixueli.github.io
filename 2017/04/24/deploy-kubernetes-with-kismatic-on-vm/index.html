<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 使用 kismatic 在虚拟机上部署 Kubernetes · Li Xueli Blog</title><meta name="description" content="使用 kismatic 在虚拟机上部署 Kubernetes - Li Xueli"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://lixueli.com/atom.xml" title="Li Xueli Blog"><script>(function(h,o,t,j,a,r){h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};h._hjSettings={hjid:2010052,hjsv:6};a=o.getElementsByTagName("head")[0];r=o.createElement("script");r.async=1;r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;a.appendChild(r)})(window,document,"https://static.hotjar.com/c/hotjar-",".js?sv=");</script></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">文章</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="/labs/" target="_self" class="nav-list-link">实验室</a></li><li class="nav-list-item"><a href="https://space.bilibili.com/7278038/#/" target="_blank" class="nav-list-link">视频</a></li><li class="nav-list-item"><a href="/contact/" target="_self" class="nav-list-link">联系我</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><div class="toc-tree"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-准备虚拟机"><span class="toc-text">1. 准备虚拟机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-准备-kismatic"><span class="toc-text">2. 准备 kismatic</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Kismatic-支持的操作系统"><span class="toc-text">1. Kismatic 支持的操作系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-下载-Kismatic"><span class="toc-text">2. 下载 Kismatic</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-确认-kismatic-可用"><span class="toc-text">3. 确认 kismatic 可用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-使用-kismatic-部署-K8s"><span class="toc-text">3. 使用 kismatic 部署 K8s</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-使用-Kismatic-的部署流程大致分为四步："><span class="toc-text">1. 使用 Kismatic 的部署流程大致分为四步：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-部署流程"><span class="toc-text">2. 部署流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-使用集群"><span class="toc-text">4. 使用集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-使用-kubectl"><span class="toc-text">1. 使用 kubectl</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-打开-Dashboard"><span class="toc-text">2. 打开 Dashboard</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-安装-Heapster"><span class="toc-text">3. 安装 Heapster</span></a></li></ol></li></ol></div><div class="tag"><a class='tag-link' href='/tags/开发/'>开发</a>    <a class='tag-link' href='/tags/k8s/'>k8s</a></div><article class="post-block"><h1 class="post-title">使用 kismatic 在虚拟机上部署 Kubernetes</h1><div class="post-info">2017年4月24日</div><div class="post-content"><p><a href="https://github.com/apprenda/kismatic" target="_blank" rel="noopener">Kismatic</a> 是 Kubernetes 的自动化部署工具，使用它可以在 Linux 上快速部署 Kubernetes。</p>
<a id="more"></a>
<h2 id="1-准备虚拟机"><a href="#1-准备虚拟机" class="headerlink" title="1. 准备虚拟机"></a>1. 准备虚拟机</h2><p>我选择的是 <a href="https://my.vultr.com" target="_blank" rel="noopener">Vultr</a> 的虚拟机，价格适中，管理方便。<br>我们需要两台虚拟机，其中 etcd、master 可以在同一个节点上，worker 单独一个节点。<br>所以我们选择两台新加坡的 CentOS 7 机器；上传 SSH 公钥，方便 SSH 登录；设置机器的 hostname；点击创建。<br>待虚拟机创建完成，你就拥有了两台带公网 IP 的节点。</p>
<p><em>说明：为什么要使用新加坡节点？延迟小，丢包少，拉取镜像又不需要翻墙。</em></p>
<h2 id="2-准备-kismatic"><a href="#2-准备-kismatic" class="headerlink" title="2. 准备 kismatic"></a>2. 准备 kismatic</h2><h3 id="1-Kismatic-支持的操作系统"><a href="#1-Kismatic-支持的操作系统" class="headerlink" title="1. Kismatic 支持的操作系统"></a>1. Kismatic 支持的操作系统</h3><pre><code>* RHEL 7
* CentOS 7
* Ubuntu 16.04
</code></pre><h3 id="2-下载-Kismatic"><a href="#2-下载-Kismatic" class="headerlink" title="2. 下载 Kismatic"></a>2. 下载 Kismatic</h3><p>在 <a href="https://github.com/apprenda/kismatic/releases" target="_blank" rel="noopener">Releases · apprenda/kismatic · GitHub</a> 页面，根据操作系统（目前支持 LInux 和 Mac）下载 kismatic 文件，放到文件夹中。<br>下面命令以 MacOS、Kismatic 1.3.0 为例。</p>
<h3 id="3-确认-kismatic-可用"><a href="#3-确认-kismatic-可用" class="headerlink" title="3. 确认 kismatic 可用"></a>3. 确认 kismatic 可用</h3><p>进入 <code>kismatic-v1.3.0-darwin-amd64</code> 文件夹，输入 <code>./kismatic help</code> 命令：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kismatic <span class="built_in">help</span></span><br></pre></td></tr></table></figure></p>
<p>如果返回 kismatic 的帮助信息，那么 kismatic 则可用，帮助信息大致如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">kismatic is the main tool <span class="keyword">for</span> managing your Kubernetes cluster</span><br><span class="line">more documentation is availble at https://github.com/apprenda/kismatic</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  kismatic</span><br><span class="line">  kismatic [<span class="built_in">command</span>]</span><br><span class="line"></span><br><span class="line">Available Commands:</span><br><span class="line">  dashboard   Opens/displays the kubernetes dashboard URL of the cluster</span><br><span class="line">  diagnose    Collects diagnostics about the nodes <span class="keyword">in</span> the cluster</span><br><span class="line">  info        Display info about nodes <span class="keyword">in</span> the cluster</span><br><span class="line">  install     install your Kubernetes cluster</span><br><span class="line">  ip          retrieve the IP address of the cluster</span><br><span class="line">  ssh         ssh into a node <span class="keyword">in</span> the cluster</span><br><span class="line">  upgrade     Upgrade your Kubernetes cluster</span><br><span class="line">  version     display the Kismatic CLI version</span><br><span class="line">  volume      manage storage volumes on your Kubernetes cluster</span><br><span class="line"></span><br><span class="line">Use <span class="string">"kismatic [command] --help"</span> <span class="keyword">for</span> more information about a <span class="built_in">command</span>.</span><br></pre></td></tr></table></figure></p>
<h2 id="3-使用-kismatic-部署-K8s"><a href="#3-使用-kismatic-部署-K8s" class="headerlink" title="3. 使用 kismatic 部署 K8s"></a>3. 使用 kismatic 部署 K8s</h2><p>文档：<a href="https://github.com/apprenda/kismatic/blob/master/docs/INSTALL.md" target="_blank" rel="noopener">kismatic/INSTALL.md at master · apprenda/kismatic · GitHub</a></p>
<h3 id="1-使用-Kismatic-的部署流程大致分为四步："><a href="#1-使用-Kismatic-的部署流程大致分为四步：" class="headerlink" title="1. 使用 Kismatic 的部署流程大致分为四步："></a>1. 使用 Kismatic 的部署流程大致分为四步：</h3><p>Plan（计划） -&gt; Provision（准备） -&gt; Validate（验证） -&gt; Apply（应用）</p>
<pre><code>* Plan（计划）：
    * 做一些部署相关的选择，Kismatic 会根据相应的选择生成一个 `kismatic-cluster.yaml` 文件。
* Provision（准备）
    * 准备机器
    * 准备网络
* Validate（验证）
    * 根据 `kismatic-cluster.yaml` 文件检查机器核网络是否可以安装。
* Apply（应用）
    * 根据 `kismatic-cluster.yaml` 文件来部署，并在结束后进行冒烟测试。
</code></pre><h3 id="2-部署流程"><a href="#2-部署流程" class="headerlink" title="2. 部署流程"></a>2. 部署流程</h3><p><strong>1.kismatic intall plan</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kismatic install plan</span><br></pre></td></tr></table></figure>
<p>由于这里是一个简易的部署，所以只设置了etcd、master、work 节点各一个，plan 的过程和结果如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Plan your Kubernetes cluster:</span><br><span class="line">=&gt; Number of etcd nodes [3]: 1</span><br><span class="line">=&gt; Number of master nodes [2]: 1</span><br><span class="line">=&gt; Number of worker nodes [3]: 1</span><br><span class="line">=&gt; Number of ingress nodes (optional, <span class="built_in">set</span> to 0 <span class="keyword">if</span> not required) [2]: 0</span><br><span class="line">=&gt; Number of storage nodes (optional, <span class="built_in">set</span> to 0 <span class="keyword">if</span> not required) [0]: 0</span><br><span class="line">=&gt; Number of existing NFS volumes to be attached [0]: 0</span><br><span class="line"></span><br><span class="line">Generating installation plan file template with:</span><br><span class="line">- 1 etcd nodes</span><br><span class="line">- 1 master nodes</span><br><span class="line">- 1 worker nodes</span><br><span class="line">- 0 ingress nodes</span><br><span class="line">- 0 storage nodes</span><br><span class="line">- 0 nfs volumes</span><br><span class="line"></span><br><span class="line">Wrote plan file template to <span class="string">"kismatic-cluster.yaml"</span></span><br><span class="line">Edit the plan file to further describe your cluster. Once ready, execute the <span class="string">"install validate"</span> <span class="built_in">command</span> to proceed.</span><br></pre></td></tr></table></figure></p>
<p>这时目录下多了一个 <code>kismatic-cluster.yaml</code> 文件，打开该文件，进行进一步的配置。</p>
<p><strong>2.修改虚拟机 hostname：</strong></p>
<p>没有修改 hostname 的时候，Validate  的时候一直报<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">verify worker node to master node connectivity using hostname [ERROR]</span><br></pre></td></tr></table></figure></p>
<p>后来发现把 hostname 改为机器 IP 就验证成功了，修改 hostname 方法如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hostname new-server-name-here</span><br><span class="line">nano /etc/hostname <span class="comment"># 修改里面的旧 hostname 为新 hostname</span></span><br><span class="line">nano /etc/hosts <span class="comment"># 把 127.0.1.1 和 ::1 之后的旧 hostname 改为新 hostname</span></span><br></pre></td></tr></table></figure></p>
<p><a href="https://www.cyberciti.biz/faq/ubuntu-change-hostname-command/" target="_blank" rel="noopener">修改 Linux hostname</a></p>
<p><strong>3.配置 kismatic-cluster.yaml</strong></p>
<p>配置 ssh：<br>修改 cluster -&gt; ssh 下的 <code>user</code> 和 <code>ssh_key</code>，<code>user</code> 一般为 <code>root</code>，<code>ssh_key</code> （本地 ssh 私钥的绝对路径），Mac 系统下一般为 <code>/Users/username/.ssh/id_rsa</code>。<br>注意：把本机的 SSH 公钥放到虚拟机 root 用户的 ~/.ssh/authorized_keys 中，确保执行 kismatic 的机器可以无密码访问部署的机器。如果在创建虚拟机的时候选择了 SSH 公钥，那么 <code>authorized_keys</code> 就已经存在了。</p>
<p>配置节点的 IP 和 hostname：<br>我们只需要配置了 etcd、master、worker 节点，节点配置大致如下：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">etcd:</span></span><br><span class="line">  <span class="attr">expected_count:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">nodes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">"虚拟机1的 IP"</span></span><br><span class="line">    <span class="attr">ip:</span> <span class="string">"虚拟机1的 IP"</span></span><br><span class="line">    <span class="attr">internalip:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">master:</span></span><br><span class="line">  <span class="attr">expected_count:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">load_balanced_fqdn:</span> <span class="string">"虚拟机1的 IP"</span></span><br><span class="line">  <span class="attr">load_balanced_short_name:</span> <span class="string">"虚拟机1的 IP"</span></span><br><span class="line">  <span class="attr">nodes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">"虚拟机1的 IP"</span></span><br><span class="line">    <span class="attr">ip:</span> <span class="string">"虚拟机1的 IP"</span></span><br><span class="line">    <span class="attr">internalip:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">worker:</span></span><br><span class="line">  <span class="attr">expected_count:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">nodes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">"虚拟机2的 IP"</span></span><br><span class="line">    <span class="attr">ip:</span> <span class="string">"虚拟机2的 IP"</span></span><br><span class="line">    <span class="attr">internalip:</span> <span class="string">""</span></span><br></pre></td></tr></table></figure></p>
<p><strong>4.关闭虚拟机上的防火墙：</strong></p>
<p>CentOS 7 会默认开启防火墙，这会导致 Kismatic 验证、安装失败。<br>通过 <code>ssh root@虚拟机 IP</code> 登录远程机器。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">disable</span> firewalld <span class="comment"># 禁用防火墙</span></span><br><span class="line">systemctl stop firewalld <span class="comment"># 停止防火墙</span></span><br><span class="line">systemctl status firewalld <span class="comment"># 查看防火墙状态</span></span><br></pre></td></tr></table></figure></p>
<p><a href="[How to Stop and Disable Firewalld on CentOS 7 – Liquid Web Knowledge Base]https://www.liquidweb.com/kb/how-to-stop-and-disable-firewalld-on-centos-7/">如何关闭 CentOS 7 的防火墙</a></p>
<p><strong>5.kismatic intall validate</strong></p>
<p>进行验证：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kismatic install validate</span><br></pre></td></tr></table></figure></p>
<p>验证完毕：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Validating==========================================================================</span><br><span class="line">Reading installation plan file <span class="string">"kismatic-cluster.yaml"</span>                          [OK]</span><br><span class="line">Validating installation plan file                                               [OK]</span><br><span class="line">Validating SSH connectivity to nodes                                            [OK]</span><br><span class="line">Configure Cluster Prerequisites                                                 [OK]</span><br><span class="line">Run Cluster Pre-Flight Checks                                                   [OK]</span><br></pre></td></tr></table></figure></p>
<p><strong>6.kismatic install apply</strong></p>
<p>进行部署：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kismatic install apply</span><br></pre></td></tr></table></figure></p>
<h2 id="4-使用集群"><a href="#4-使用集群" class="headerlink" title="4. 使用集群"></a>4. 使用集群</h2><h3 id="1-使用-kubectl"><a href="#1-使用-kubectl" class="headerlink" title="1. 使用 kubectl"></a>1. 使用 kubectl</h3><p>在 kismatic 文件夹中使用 <code>kubectl --kubeconfig generated/kubeconfig</code> 命令<br>或者复制配置文件 cp generated/kubeconfig ~/.kube/config</p>
<h3 id="2-打开-Dashboard"><a href="#2-打开-Dashboard" class="headerlink" title="2. 打开 Dashboard"></a>2. 打开 Dashboard</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kismatic dashboard</span><br></pre></td></tr></table></figure>
<p>会打开 <a href="https://45.76.186.209:6443/ui，登录名为" target="_blank" rel="noopener">https://45.76.186.209:6443/ui，登录名为</a> root，密码为 <code>kismatic-cluster.yamlDashboard</code> 中 <code>admin_password</code> 字段的值，Dashboard 显示如下：<br><img src="http://ww2.sinaimg.cn/large/006tNbRwgy1fexypn8vctj30zm0m9djl.jpg" alt="Kubernetes Dashboard"></p>
<h3 id="3-安装-Heapster"><a href="#3-安装-Heapster" class="headerlink" title="3. 安装 Heapster"></a>3. 安装 Heapster</h3><ol>
<li>克隆 <a href="[GitHub - kubernetes/heapster: Compute Resource Usage Analysis and Monitoring of Container Clusters]https://github.com/kubernetes/heapster">heapster repo</a> 到本地</li>
<li>在 kismatic 文件夹中 <code>kubectl --kubeconfig generated/kubeconfig create -f path/to/heapster/deploy/kube-config/influxdb/</code></li>
<li>等待 heapster 安装完成，刷新 Dashboard，监控图表已经出现了：<br><img src="http://ww4.sinaimg.cn/large/006tNbRwgy1fexynfmtvhj30zm0m9djl.jpg" alt="安装了 Heapster 的 Kubernetes Dashboard"></li>
</ol>
</div></article></div><div class="cc">版权声明：<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">非商业性使用-禁止演绎 3.0(CC BY-NC-ND 3.0)</a></div></main><footer><div class="paginator"><a href="/2017/05/13/frontend-basic-resource/" class="prev">上一篇</a><a href="/2017/04/19/mac-chrome-network-problem/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'lixueli';
var disqus_identifier = '2017/04/24/deploy-kubernetes-with-kismatic-on-vm/';
var disqus_title = '使用 kismatic 在虚拟机上部署 Kubernetes';
var disqus_url = 'http://lixueli.com/2017/04/24/deploy-kubernetes-with-kismatic-on-vm/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//lixueli.disqus.com/count.js" async></script><div class="copyright"><p>© 2017 - 2021 <a href="http://lixueli.com">Li Xueli</a>, powered <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/mixj93/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-112756013-1",'auto');ga('send','pageview');</script></body></html>